<Biml xmlns="http://schemas.varigence.com/biml.xsd">
  <Connections>
    <OleDbConnection Name="LOG" ConnectionString="{{ Connections.Log.ConnectionString }}" CreateInProject="true"/>
    <OleDbConnection Name="TMP" ConnectionString="{{ Connections.Staging.ConnectionString }}" CreateInProject="true"/>
    <OleDbConnection Name="STG" ConnectionString="{{ Connections.Staging.ConnectionString }}" CreateInProject="true" />
    <OleDbConnection Name="DWH" ConnectionString="{{ Connections.DataWarehouse.ConnectionString }};" CreateInProject="true" />
  </Connections>
  <Packages>
    <Package Name="Load_DIM_{{ Dimension.Name }}" AutoCreateConfigurationsType="None" ConstraintMode="Parallel" ProtectionLevel="EncryptSensitiveWithUserKey">
      <Annotations>
        <Annotation AnnotationType="Description">
          <![CDATA[ 
              SolidQ Adaptive BI Framework 3.0

	            Compilation:
		            Date			        : {{ ABI3.Compiler.CompilationDateTime }}

	            Template:
		            Phase			        : Load
		            Pattern			      : Dimension
                Implementation    : Business Key
		            Type			        : BIML
		            Author			      : dmauri
                Version           : 2.1               
                
              Description:
                Load a dimension taking care of SCD1 and SCD2 handling. Log inserted and updated rows.
                
          ]]>
        </Annotation>
      </Annotations>
      <Variables>
        <Variable Name="RowsToMerge" DataType="Int32" Namespace="User">0</Variable>
        <Variable Name="LoadedRows" DataType="Int32" Namespace="User">0</Variable>
        <Variable Name="LogRowId" DataType="Int32" Namespace="User">0</Variable>
        <Variable Name="CS" DataType="String" Namespace="User" EvaluateAsExpression="true">
          <![CDATA["<inserted_rows>" + (DT_WSTR, 12)@[User::LoadedRows] + "</inserted_rows><updated_rows>" + (DT_WSTR, 12)@[User::RowsToMerge] + "</updated_rows>"]]>
        </Variable>
      </Variables>
      <Connections>
        <Connection ConnectionName="LOG" Id="00000000-0000-0000-0000-000000000001" />
        <Connection ConnectionName="TMP" Id="00000000-0000-0000-0000-000000000002" />
        <Connection ConnectionName="STG" Id="00000000-0000-0000-0000-000000000003" />
        <Connection ConnectionName="DWH" Id="00000000-0000-0000-0000-000000000004" />
      </Connections>
      <Tasks>
        <ExecuteSQL Name="Set Load Start" ConnectionName="LOG" ResultSet="SingleRow">         
          <DirectInput>
            DECLARE @rowId INT;
            EXEC @rowId = [log].[stp_etl_table_load_info_set_start] '{{ Connections.DataWarehouse.Database }}', 'dwh', 'dim_{{ Dimension.Name }}', 'I', ?;
            SELECT CAST(@rowId AS INT) AS RowId
          </DirectInput>
          <Parameters>
            <Parameter Name="@serverExecutionId" VariableName="System.ServerExecutionID" DataType="Int64" Direction="Input"/>
          </Parameters>
          <Results>
            <Result Name="RowId" VariableName="User.LogRowId" />
          </Results>
        </ExecuteSQL>
        <Container ConstraintMode="Parallel" Name="Load Data">
          <PrecedenceConstraints>
            <Inputs>
              <Input OutputPathName="Set Load Start.Output" EvaluationOperation="Constraint" EvaluationValue="Success"/>
            </Inputs>
          </PrecedenceConstraints>
          <Tasks>
            <ExecuteSQL Name="Clean TMP Table" ConnectionName="TMP">
              <DirectInput>TRUNCATE TABLE tmp.dim_{{Dimension.Name}};</DirectInput>
            </ExecuteSQL>
            <Dataflow Name="Load Dimension">
              <PrecedenceConstraints>
                <Inputs>
                  <Input OutputPathName="Clean TMP Table.Output"/>
                </Inputs>
              </PrecedenceConstraints>
              <Transformations>
                <OleDbSource Name="STG" ConnectionName="STG">
                  <DirectInput>SELECT * FROM {{ Dimension.Source.FullName }} OPTION (RECOMPILE)</DirectInput>
                </OleDbSource>
                {% if Dimension.Columns.SCD1 != empty -%}
                <CustomComponent Name="Calculate SCD1 Checksum" ComponentTypeName="Martin.SQLServer.Dts.MultipleHash, MultipleHash{{ ABI3.Project.TargetSQLPlatformVersion }}, Version=1.0.0.0, Culture=neutral, PublicKeyToken=51c551904274ab44">
                  <CustomProperties>
                    <CustomProperty Name="MultipleThreads" DataType="Int32" TypeConverter="Martin.SQLServer.Dts.MultipleHash+MultipleThread, MultipleHash{{ ABI3.Project.TargetSQLPlatformVersion }}, Version=1.0.0.0, Culture=neutral, PublicKeyToken=51c551904274ab44">1</CustomProperty>
                    <CustomProperty Name="SafeNullHandling" DataType="Int32" TypeConverter="Martin.SQLServer.Dts.MultipleHash+MultipleThread, MultipleHash{{ ABI3.Project.TargetSQLPlatformVersion }}, Version=1.0.0.0, Culture=neutral, PublicKeyToken=51c551904274ab44">1</CustomProperty>
                  </CustomProperties>
                  <InputPaths>
                    <InputPath Identifier="Input" OutputPathName="STG.Output">
                      <InputColumns>
                        {% for column in Dimension.Columns.SCD1 -%}
                        <InputColumn SourceColumn="{{ column.Name }}" />
                        {% endfor -%}
                      </InputColumns>
                    </InputPath>
                  </InputPaths>
                  <OutputPaths>
                    <OutputPath Name="HashedOutput" SynchronousInput="Input">
                      <OutputColumns>
                        <OutputColumn Name="scd1_checksum" DataType="Binary" Length="8">
                          <CustomProperties>
                            <Property Name="HashType" DataType="Int32" TypeConverter="Martin.SQLServer.Dts.MultipleHash+MultipleThread, MultipleHash{{ ABI3.Project.TargetSQLPlatformVersion }}, Version=1.0.0.0, Culture=neutral, PublicKeyToken=51c551904274ab44">10</Property>
                            <Property Name="InputColumnLineageIDs" ContainsId="true" TranslateValueToLineageId="true" LineageIdListSeparator="," DataType="String">{{ Dimension.Columns.SCD1 | Map: 'Name' | Join: ',' }}</Property>
                          </CustomProperties>
                        </OutputColumn>
                      </OutputColumns>
                    </OutputPath>
                  </OutputPaths>
                </CustomComponent>
                {% endif -%}
                {% if Dimension.Columns.SCD2 != empty -%}
                <CustomComponent Name="Calculate SCD2 Checksum" ComponentTypeName="Martin.SQLServer.Dts.MultipleHash, MultipleHash{{ ABI3.Project.TargetSQLPlatformVersion }}, Version=1.0.0.0, Culture=neutral, PublicKeyToken=51c551904274ab44">
                  <CustomProperties>
                    <CustomProperty Name="MultipleThreads" DataType="Int32" TypeConverter="Martin.SQLServer.Dts.MultipleHash+MultipleThread, MultipleHash{{ ABI3.Project.TargetSQLPlatformVersion }}, Version=1.0.0.0, Culture=neutral, PublicKeyToken=51c551904274ab44">1</CustomProperty>
                    <CustomProperty Name="SafeNullHandling" DataType="Int32" TypeConverter="Martin.SQLServer.Dts.MultipleHash+MultipleThread, MultipleHash{{ ABI3.Project.TargetSQLPlatformVersion }}, Version=1.0.0.0, Culture=neutral, PublicKeyToken=51c551904274ab44">1</CustomProperty>
                  </CustomProperties>
                  <InputPaths>
                    <InputPath Identifier="Input" OutputPathName="Calculate SCD1 Checksum.HashedOutput">
                      <InputColumns>
                        {% for column in Dimension.Columns.SCD2 -%}
                        <InputColumn SourceColumn="{{ column.Name }}" />
                        {% endfor -%}
                      </InputColumns>
                    </InputPath>
                  </InputPaths>
                  <OutputPaths>
                    <OutputPath Name="HashedOutput" SynchronousInput="Input">
                      <OutputColumns>
                        <OutputColumn Name="scd2_checksum" DataType="Binary" Length="8">
                          <CustomProperties>
                            <Property Name="HashType" DataType="Int32" TypeConverter="Martin.SQLServer.Dts.MultipleHash+MultipleThread, MultipleHash{{ ABI3.Project.TargetSQLPlatformVersion }}, Version=1.0.0.0, Culture=neutral, PublicKeyToken=51c551904274ab44">10</Property>
                            <Property Name="InputColumnLineageIDs" ContainsId="true" TranslateValueToLineageId="true" LineageIdListSeparator="," DataType="String">{{ Dimension.Columns.SCD2 | Map: 'Name' | Join: ',' }}</Property>
                          </CustomProperties>
                        </OutputColumn>
                      </OutputColumns>
                    </OutputPath>
                  </OutputPaths>
                </CustomComponent>
                {% endif -%}
                <DerivedColumns Name="Add Metadata">
                  <Columns>
                    <Column Name="$sq_log_id" DataType="Int32">@LogRowId</Column>
                  </Columns>
                </DerivedColumns>
                <Lookup Name="Lookup Dimension" OleDbConnectionName="DWH" NoMatchBehavior="IgnoreFailure">
                  <DirectInput>SELECT id_dim_{{ Dimension.Name }}, {{ Dimension.Columns.UniqueKey | Map: 'Name' | Join: ',' }}, scd1_checksum, scd2_checksum FROM [dwh].[dim_{{ Dimension.Name }}] WHERE scd2_valid_to = '99991231'</DirectInput>
                  <Inputs>
                    {% for column in Dimension.Columns.UniqueKey -%}
                    <Column SourceColumn="{{ column.Name }}" TargetColumn="{{ column.Name }}"/>
                    {% endfor -%}
                  </Inputs>
                  <Outputs>
                    <Column SourceColumn="id_dim_{{ Dimension.Name }}" TargetColumn="id_dim_{{ Dimension.Name }}" />
                    <Column SourceColumn="scd1_checksum" TargetColumn="l_scd1_checksum" />
                    <Column SourceColumn="scd2_checksum" TargetColumn="l_scd2_checksum" />
                  </Outputs>
                </Lookup>
                <ConditionalSplit Name="Split New vs Existing Rows">
                  <OutputPaths>
                    <OutputPath Name="New Rows">
                      <Expression>ISNULL(id_dim_{{ Dimension.Name }})</Expression>
                    </OutputPath>
                  </OutputPaths>
                </ConditionalSplit>
                
                <DerivedColumns Name="Add New Rows Valid Date">
                  <InputPath OutputPathName="Split New vs Existing Rows.New Rows" />
                  <Columns>
                    <Column Name="scd2_valid_from" DataType="Date">(DT_DBDATE)("0001-01-01")</Column>
                    <Column Name="scd2_valid_to" DataType="Date">(DT_DBDATE)("9999-12-31")</Column>
                  </Columns>
                </DerivedColumns>
                <RowCount Name="Count New Rows" VariableName="User.LoadedRows">
                  <InputPath OutputPathName="Add New Rows Valid Date.Output" />
                </RowCount>
                <OleDbDestination Name="DWH" ConnectionName="DWH" UseFastLoadIfAvailable="true">
                  <InputPath OutputPathName="Count New Rows.Output" />
                  <ExternalTableOutput Table="dwh.dim_{{ Dimension.Name }}"/>
                  <Columns>
                    <Column SourceColumn="id_dim_{{ Dimension.Name }}" IsUsed="false" />
                  </Columns>
                </OleDbDestination>
                
                <Multicast Name="Multicast">
                  <InputPath OutputPathName="Split New vs Existing Rows.Default" />
                  <OutputPaths>
                    <OutputPath Name="SCD1"/>
                    <OutputPath Name="SCD2"/>
                  </OutputPaths>
                </Multicast>
                
                {% if Dimension.Columns.SCD1 != empty -%}
                <ConditionalSplit Name="Filter SCD1 Changed Rows">
                  <InputPath OutputPathName="Multicast.SCD1" />
                  <OutputPaths>
                    <OutputPath Name="Changed Rows">
                      <Expression>(DT_I8)scd1_checksum != (DT_I8)l_scd1_checksum</Expression>
                    </OutputPath>
                  </OutputPaths>
                </ConditionalSplit>
                <DerivedColumns Name="Set SCD Type 1">
                  <InputPath OutputPathName="Filter SCD1 Changed Rows.Changed Rows" />
                  <Columns>
                    <Column Name="scd_type" DataType="Int32">1</Column>
                  </Columns>
                </DerivedColumns>
                <DerivedColumns Name="Add SCD1 Rows Valid Date">
                  <InputPath OutputPathName="Set SCD Type 1.Output" />
                  <Columns>
                    <Column Name="scd2_valid_from" DataType="Date">NULL(DT_DBDATE)</Column>
                    <Column Name="scd2_valid_to" DataType="Date">NULL(DT_DBDATE)</Column>
                  </Columns>
                </DerivedColumns>
                {% endif -%}

                {% if Dimension.Columns.SCD2 != empty -%}
                <ConditionalSplit Name="Filter SCD2 Changed Rows">
                  <InputPath OutputPathName="Multicast.SCD2" />
                  <OutputPaths>
                    <OutputPath Name="Changed Rows">
                      <Expression>(DT_I8)scd2_checksum != (DT_I8)l_scd2_checksum</Expression>
                    </OutputPath>
                  </OutputPaths>
                </ConditionalSplit>
                <DerivedColumns Name="Set SCD Type 2">
                  <InputPath OutputPathName="Filter SCD2 Changed Rows.Changed Rows" />
                  <Columns>
                    <Column Name="scd_type" DataType="Int32">2</Column>
                  </Columns>
                </DerivedColumns>
                <DerivedColumns Name="Add SCD2 Rows Valid Date">
                  <InputPath OutputPathName="Set SCD Type 2.Output" />
                  <Columns>
                    <Column Name="scd2_valid_from" DataType="Date">(DT_DBDATE)GETDATE()</Column>
                    <Column Name="scd2_valid_to" DataType="Date">(DT_DBDATE)("9999-12-31")</Column>
                  </Columns>
                </DerivedColumns>
                {% endif -%}

                <UnionAll Name="Union All">
                  <InputPaths>
                    <InputPath OutputPathName="Add SCD1 Rows Valid Date.Output" />
                    <InputPath OutputPathName="Add SCD2 Rows Valid Date.Output" />
                  </InputPaths>
                </UnionAll>
                <RowCount Name="Count Changed Rows" VariableName="User.RowsToMerge">
                  <InputPath OutputPathName="Union All.Output" />
                </RowCount>
                <OleDbDestination Name="TMP" ConnectionName="TMP" UseFastLoadIfAvailable="true">
                  <InputPath OutputPathName="Count Changed Rows.Output" />
                  <ExternalTableOutput Table="tmp.dim_{{ Dimension.Name }}" />
                </OleDbDestination>
                
              </Transformations>
            </Dataflow>
            {% if Dimension.Columns.SCD1 != empty -%}
            <ExecuteSQL Name="Handle SCD Merge" ConnectionName="STG">
              <PrecedenceConstraints>
                <Inputs>
                  <Input OutputPathName="Load Dimension.Output" EvaluationOperation="ExpressionAndConstraint" Expression="@RowsToMerge > 0" EvaluationValue="Success"/>
                </Inputs>
              </PrecedenceConstraints>
              <DirectInput>EXEC [etl].[stp_merge_dim_{{ Dimension.Name }}];</DirectInput>
            </ExecuteSQL>
            {% endif -%}
            <ExecuteSQL Name="Add Dummy Member" ConnectionName="STG">
              <PrecedenceConstraints>
                <Inputs>
                  <Input OutputPathName="Load Dimension.Output"/>
                </Inputs>
              </PrecedenceConstraints>
              <DirectInput>EXEC [etl].[stp_add_dummy_dim_{{ Dimension.Name }}];</DirectInput>
            </ExecuteSQL>
          </Tasks>
        </Container>
        <ExecuteSQL Name="Set Load End Success" ConnectionName="LOG">
          <PrecedenceConstraints>
            <Inputs>
              <Input OutputPathName="Load Data.Output" EvaluationOperation="Constraint" EvaluationValue="Success"/>
            </Inputs>
          </PrecedenceConstraints>
          <DirectInput>EXEC [log].stp_etl_table_load_info_set_end_cs ?, ?, 'S';</DirectInput>
          <Parameters>
            <Parameter Name="@rowId" VariableName="User.LogRowId" DataType="Int32" Direction="Input" />
            <Parameter Name="@xcs" VariableName="User.CS" DataType="String" Direction="Input" />
          </Parameters>
        </ExecuteSQL>
        <ExecuteSQL Name="Set Load End Failure" ConnectionName="LOG">
          <PrecedenceConstraints>
            <Inputs>
              <Input OutputPathName="Load Data.Output" EvaluationOperation="Constraint" EvaluationValue="Failure"/>
            </Inputs>
          </PrecedenceConstraints>
          <DirectInput>EXEC [log].[stp_etl_table_load_info_set_end] ?, ?, 'F';</DirectInput>
          <Parameters>
            <Parameter Name="@rowId" VariableName="User.LogRowId" DataType="Int32" Direction="Input" />
            <Parameter Name="@rows" VariableName="User.LoadedRows" DataType="Int32" Direction="Input" />
          </Parameters>
        </ExecuteSQL>
      </Tasks>
    </Package>
  </Packages>
</Biml>